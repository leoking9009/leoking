<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î™∏Î¨¥Í≤å Í¥ÄÎ¶¨ ÌîÑÎ°úÍ∑∏Îû®</title>
    <meta name="description" content="Í∞ÑÎã®Ìïú Ïõπ Í∏∞Î∞ò Î™∏Î¨¥Í≤å Í¥ÄÎ¶¨ Î∞è Ï∂îÏ†Å ÏãúÏä§ÌÖú">
    
    <style>
        /* CSS ÏΩîÎìú - Î∏åÎùºÏö∞Ï†Ä Ìò∏ÌôòÏÑ± Í∞ïÌôî */
        * {
            margin: 0;
            padding: 0;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
            background: #667eea;
            background: -webkit-linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            -webkit-box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: #4CAF50;
            background: -webkit-linear-gradient(45deg, #4CAF50, #45a049);
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            text-align: center;
            padding: 2rem;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        main {
            padding: 2rem;
        }

        section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }

        section h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .input-group {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            gap: 10px;
            -webkit-flex-wrap: wrap;
            -ms-flex-wrap: wrap;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        input {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            -ms-flex: 1;
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            -webkit-transition: border-color 0.3s;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        button {
            padding: 12px 20px;
            background: #4CAF50;
            background: -webkit-linear-gradient(45deg, #4CAF50, #45a049);
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            -webkit-transition: transform 0.2s;
            transition: transform 0.2s;
        }

        button:hover {
            -webkit-transform: translateY(-2px);
            transform: translateY(-2px);
        }

        button:active {
            -webkit-transform: translateY(0);
            transform: translateY(0);
        }

        .result-display {
            padding: 15px;
            margin-top: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            min-height: 20px;
        }

        .bmi-underweight { background: #e3f2fd; color: #1976d2; }
        .bmi-normal { background: #e8f5e8; color: #4caf50; }
        .bmi-overweight { background: #fff3e0; color: #ff9800; }
        .bmi-obese { background: #ffebee; color: #f44336; }
        .goal-set { background: #e8f5e8; color: #4caf50; }
        .error-message { background: #ffebee; color: #f44336; }
        .success-message { background: #e8f5e8; color: #4caf50; }

        .record-item {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            -ms-flex-pack: justify;
            justify-content: space-between;
            -webkit-box-align: center;
            -webkit-align-items: center;
            -ms-flex-align: center;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            -webkit-box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .record-item .date {
            font-weight: bold;
            color: #666;
        }

        .record-item .weight {
            font-size: 1.2rem;
            color: #4CAF50;
            font-weight: bold;
        }

        .delete-btn {
            background: #f44336;
            padding: 5px 10px;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #d32f2f;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            margin: 1rem 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            -ms-flex-align: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            -ms-flex-pack: center;
            justify-content: center;
        }

        .simple-chart {
            width: 100%;
            height: 100%;
            padding: 20px;
        }

        .chart-message {
            color: #666;
            text-align: center;
            font-style: italic;
        }

        .offline-indicator {
            background: #ff9800;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            .input-group {
                -webkit-box-orient: vertical;
                -webkit-box-direction: normal;
                -webkit-flex-direction: column;
                -ms-flex-direction: column;
                flex-direction: column;
            }
            
            input, button {
                width: 100%;
            }
            
            .record-item {
                -webkit-box-orient: vertical;
                -webkit-box-direction: normal;
                -webkit-flex-direction: column;
                -ms-flex-direction: column;
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }

        /* Î°úÎî© Ïä§ÌîºÎÑà */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="offline-indicator" class="offline-indicator" style="display: none;">
        üîå Ïò§ÌîÑÎùºÏù∏ Î™®Îìú
    </div>
    
    <div class="container">
        <header>
            <h1>üìä Î™∏Î¨¥Í≤å Í¥ÄÎ¶¨ ÌîÑÎ°úÍ∑∏Îû®</h1>
            <p>Í±¥Í∞ïÌïú Ï≤¥Ï§ë Í¥ÄÎ¶¨Î•º ÏúÑÌïú Ïä§ÎßàÌä∏ Ìä∏ÎûòÏª§</p>
        </header>
        
        <main>
            <!-- BMI Í≥ÑÏÇ∞Í∏∞ ÏÑπÏÖò -->
            <section class="bmi-section">
                <h2>BMI Í≥ÑÏÇ∞Í∏∞</h2>
                <div class="input-group">
                    <input type="number" id="height" placeholder="ÌÇ§ (cm)" min="1" max="300" step="1">
                    <input type="number" id="weight" placeholder="Î™∏Î¨¥Í≤å (kg)" min="1" max="500" step="0.1">
                    <button onclick="calculateBMI()" id="bmi-btn">BMI Í≥ÑÏÇ∞</button>
                </div>
                <div id="bmi-result" class="result-display"></div>
            </section>

            <!-- Î™©Ìëú ÏÑ§Ï†ï ÏÑπÏÖò -->
            <section class="goal-section">
                <h2>Î™©Ìëú Ï≤¥Ï§ë ÏÑ§Ï†ï</h2>
                <div class="input-group">
                    <input type="number" id="target-weight" placeholder="Î™©Ìëú Ï≤¥Ï§ë (kg)" min="1" max="500" step="0.1">
                    <button onclick="setGoal()" id="goal-btn">Î™©Ìëú ÏÑ§Ï†ï</button>
                </div>
                <div id="goal-display" class="result-display"></div>
            </section>

            <!-- Ï≤¥Ï§ë Í∏∞Î°ù ÏÑπÏÖò -->
            <section class="record-section">
                <h2>Ï≤¥Ï§ë Í∏∞Î°ù</h2>
                <div class="input-group">
                    <input type="text" id="record-date" placeholder="YYYY-MM-DD">
                    <input type="number" id="record-weight" placeholder="Î™∏Î¨¥Í≤å (kg)" min="1" max="500" step="0.1">
                    <button onclick="addRecord()" id="record-btn">Í∏∞Î°ù Ï∂îÍ∞Ä</button>
                </div>
                <div id="record-result" class="result-display"></div>
            </section>

            <!-- Ï∞®Ìä∏ ÏÑπÏÖò -->
            <section class="chart-section">
                <h2>Ï≤¥Ï§ë Î≥ÄÌôî Í∑∏ÎûòÌîÑ</h2>
                <div class="chart-container">
                    <canvas id="weightChart" style="display: none;"></canvas>
                    <div id="simple-chart" class="simple-chart"></div>
                </div>
            </section>

            <!-- Í∏∞Î°ù Î™©Î°ù ÏÑπÏÖò -->
            <section class="history-section">
                <h2>Í∏∞Î°ù ÎÇ¥Ïó≠</h2>
                <div id="records-list"></div>
            </section>
        </main>
    </div>
    
    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò Î∞è ÏÑ§Ï†ï
        let weightRecords = [];
        let targetWeight = null;
        let chart = null;
        let isOnline = navigator.onLine;
        let chartJsLoaded = false;

        // Ï†ÄÏû•ÏÜå ÎûòÌçº (ÏóêÎü¨ Ï≤òÎ¶¨ Ìè¨Ìï®)
        const storage = {
            get: function(key, defaultValue = null) {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.warn('localStorage get error:', e);
                    return defaultValue;
                }
            },
            set: function(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.warn('localStorage set error:', e);
                    return false;
                }
            },
            remove: function(key) {
                try {
                    localStorage.removeItem(key);
                    return true;
                } catch (e) {
                    console.warn('localStorage remove error:', e);
                    return false;
                }
            }
        };

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
        function showMessage(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.innerHTML = message;
            element.className = 'result-display ' + (type === 'error' ? 'error-message' : 'success-message');
            
            if (type === 'success') {
                setTimeout(() => {
                    element.innerHTML = '';
                    element.className = 'result-display';
                }, 3000);
            }
        }

        function validateNumber(value, min = 0, max = 1000) {
            const num = parseFloat(value);
            return !isNaN(num) && num >= min && num <= max;
        }

        function formatDate(dateString) {
            try {
                if (!dateString) return '';
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                return date.toLocaleDateString('ko-KR');
            } catch (e) {
                return dateString;
            }
        }

        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        // ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉú Í¥ÄÎ¶¨
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const indicator = document.getElementById('offline-indicator');
            if (indicator) {
                indicator.style.display = isOnline ? 'none' : 'block';
            }
        }

        // Chart.js Î°úÎìú ÏãúÎèÑ
        function loadChartJs() {
            if (chartJsLoaded || !isOnline) {
                return Promise.resolve(false);
            }
            
            return new Promise((resolve) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
                script.onload = function() {
                    chartJsLoaded = true;
                    resolve(true);
                };
                script.onerror = function() {
                    console.warn('Chart.js Î°úÎìú Ïã§Ìå®');
                    resolve(false);
                };
                script.timeout = 5000; // 5Ï¥à ÌÉÄÏûÑÏïÑÏõÉ
                document.head.appendChild(script);
            });
        }

        // BMI Í≥ÑÏÇ∞ Ìï®Ïàò (Í∞ïÌôîÎêú ÏóêÎü¨ Ï≤òÎ¶¨)
        function calculateBMI() {
            const heightInput = document.getElementById('height');
            const weightInput = document.getElementById('weight');
            const btn = document.getElementById('bmi-btn');
            
            if (!heightInput || !weightInput || !btn) {
                showMessage('bmi-result', 'ÏãúÏä§ÌÖú Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                return;
            }
            
            const height = heightInput.value.trim();
            const weight = weightInput.value.trim();
            
            if (!height || !weight) {
                showMessage('bmi-result', 'ÌÇ§ÏôÄ Î™∏Î¨¥Í≤åÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            if (!validateNumber(height, 50, 300) || !validateNumber(weight, 10, 500)) {
                showMessage('bmi-result', 'Ïò¨Î∞îÎ•∏ ÏàòÏπòÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (ÌÇ§: 50-300cm, Î™∏Î¨¥Í≤å: 10-500kg)', 'error');
                return;
            }
            
            try {
                btn.innerHTML = '<span class="loading"></span> Í≥ÑÏÇ∞ Ï§ë...';
                btn.disabled = true;
                
                setTimeout(() => {
                    const heightM = parseFloat(height) / 100;
                    const weightKg = parseFloat(weight);
                    const bmi = weightKg / (heightM * heightM);
                    
                    let category, className;
                    
                    if (bmi < 18.5) {
                        category = 'Ï†ÄÏ≤¥Ï§ë';
                        className = 'bmi-underweight';
                    } else if (bmi < 23) {
                        category = 'Ï†ïÏÉÅ';
                        className = 'bmi-normal';
                    } else if (bmi < 25) {
                        category = 'Í≥ºÏ≤¥Ï§ë';
                        className = 'bmi-overweight';
                    } else {
                        category = 'ÎπÑÎßå';
                        className = 'bmi-obese';
                    }
                    
                    const resultDiv = document.getElementById('bmi-result');
                    if (resultDiv) {
                        resultDiv.innerHTML = 'BMI: ' + bmi.toFixed(1) + ' (' + category + ')';
                        resultDiv.className = 'result-display ' + className;
                    }
                    
                    btn.innerHTML = 'BMI Í≥ÑÏÇ∞';
                    btn.disabled = false;
                }, 500);
                
            } catch (error) {
                console.error('BMI Í≥ÑÏÇ∞ Ïò§Î•ò:', error);
                showMessage('bmi-result', 'BMI Í≥ÑÏÇ∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                btn.innerHTML = 'BMI Í≥ÑÏÇ∞';
                btn.disabled = false;
            }
        }

        // Î™©Ìëú Ï≤¥Ï§ë ÏÑ§Ï†ï (Í∞ïÌôîÎêú Í≤ÄÏ¶ù)
        function setGoal() {
            const goalInput = document.getElementById('target-weight');
            const btn = document.getElementById('goal-btn');
            
            if (!goalInput || !btn) {
                showMessage('goal-display', 'ÏãúÏä§ÌÖú Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                return;
            }
            
            const goalWeight = goalInput.value.trim();
            
            if (!goalWeight) {
                showMessage('goal-display', 'Î™©Ìëú Ï≤¥Ï§ëÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            if (!validateNumber(goalWeight, 10, 500)) {
                showMessage('goal-display', 'Ïò¨Î∞îÎ•∏ Î™©Ìëú Ï≤¥Ï§ëÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (10-500kg)', 'error');
                return;
            }
            
            try {
                btn.innerHTML = '<span class="loading"></span> ÏÑ§Ï†ï Ï§ë...';
                btn.disabled = true;
                
                setTimeout(() => {
                    targetWeight = parseFloat(goalWeight);
                    storage.set('targetWeight', targetWeight);
                    
                    displayGoal();
                    updateChart();
                    goalInput.value = '';
                    
                    btn.innerHTML = 'Î™©Ìëú ÏÑ§Ï†ï';
                    btn.disabled = false;
                    showMessage('goal-display', 'Î™©Ìëú Ï≤¥Ï§ëÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§!', 'success');
                }, 300);
                
            } catch (error) {
                console.error('Î™©Ìëú ÏÑ§Ï†ï Ïò§Î•ò:', error);
                showMessage('goal-display', 'Î™©Ìëú ÏÑ§Ï†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                btn.innerHTML = 'Î™©Ìëú ÏÑ§Ï†ï';
                btn.disabled = false;
            }
        }

        // Î™©Ìëú Ï≤¥Ï§ë ÌëúÏãú
        function displayGoal() {
            const goalDisplay = document.getElementById('goal-display');
            if (!goalDisplay) return;
            
            if (targetWeight) {
                goalDisplay.innerHTML = 'Î™©Ìëú Ï≤¥Ï§ë: ' + targetWeight + 'kg';
                goalDisplay.className = 'result-display goal-set';
            }
        }

        // Ï≤¥Ï§ë Í∏∞Î°ù Ï∂îÍ∞Ä (Í∞ïÌôîÎêú Í≤ÄÏ¶ù Î∞è ÏóêÎü¨ Ï≤òÎ¶¨)
        function addRecord() {
            const dateInput = document.getElementById('record-date');
            const weightInput = document.getElementById('record-weight');
            const btn = document.getElementById('record-btn');
            
            if (!dateInput || !weightInput || !btn) {
                showMessage('record-result', 'ÏãúÏä§ÌÖú Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                return;
            }
            
            const date = dateInput.value.trim();
            const weight = weightInput.value.trim();
            
            if (!date || !weight) {
                showMessage('record-result', 'ÎÇ†ÏßúÏôÄ Î™∏Î¨¥Í≤åÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            // ÎÇ†Ïßú ÌòïÏãù Í≤ÄÏ¶ù
            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                showMessage('record-result', 'Ïò¨Î∞îÎ•∏ ÎÇ†Ïßú ÌòïÏãùÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (YYYY-MM-DD)', 'error');
                return;
            }
            
            if (!validateNumber(weight, 10, 500)) {
                showMessage('record-result', 'Ïò¨Î∞îÎ•∏ Î™∏Î¨¥Í≤åÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî. (10-500kg)', 'error');
                return;
            }
            
            try {
                btn.innerHTML = '<span class="loading"></span> Ï†ÄÏû• Ï§ë...';
                btn.disabled = true;
                
                setTimeout(() => {
                    const newRecord = {
                        date: date,
                        weight: parseFloat(weight),
                        timestamp: Date.now()
                    };
                    
                    // Í∞ôÏùÄ ÎÇ†Ïßú Í∏∞Î°ùÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                    const existingIndex = weightRecords.findIndex(record => record.date === date);
                    
                    if (existingIndex !== -1) {
                        if (confirm('Í∞ôÏùÄ ÎÇ†ÏßúÏóê Ïù¥ÎØ∏ Í∏∞Î°ùÏù¥ ÏûàÏäµÎãàÎã§. ÎçÆÏñ¥Ïì∞ÏãúÍ≤†ÏäµÎãàÍπå?')) {
                            weightRecords[existingIndex] = newRecord;
                        } else {
                            btn.innerHTML = 'Í∏∞Î°ù Ï∂îÍ∞Ä';
                            btn.disabled = false;
                            return;
                        }
                    } else {
                        weightRecords.push(newRecord);
                    }
                    
                    // ÎÇ†ÏßúÏàú Ï†ïÎ†¨
                    weightRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    // Ï†ÄÏû•
                    if (storage.set('weightRecords', weightRecords)) {
                        showMessage('record-result', 'Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
                        weightInput.value = '';
                        displayRecords();
                        updateChart();
                    } else {
                        // Î°§Î∞±
                        weightRecords.splice(existingIndex !== -1 ? existingIndex : weightRecords.length - 1, 0, record);
                        alert('Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                    }
                    
                    btn.innerHTML = 'Í∏∞Î°ù Ï∂îÍ∞Ä';
                    btn.disabled = false;
                }, 300);
                
            } catch (error) {
                console.error('Í∏∞Î°ù Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                showMessage('record-result', 'Í∏∞Î°ù Ï∂îÍ∞Ä Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
                btn.innerHTML = 'Í∏∞Î°ù Ï∂îÍ∞Ä';
                btn.disabled = false;
            }
        }

        // Í∏∞Î°ù Î™©Î°ù ÌëúÏãú
        function displayRecords() {
            const recordsList = document.getElementById('records-list');
            if (!recordsList) return;
            
            if (weightRecords.length === 0) {
                recordsList.innerHTML = '<p style="text-align: center; color: #666;">ÏïÑÏßÅ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }
            
            try {
                const recordsHTML = weightRecords
                    .slice()
                    .reverse() // ÏµúÏã† Í∏∞Î°ùÏùÑ ÏúÑÎ°ú
                    .map((record, index) => {
                        const actualIndex = weightRecords.length - 1 - index;
                        return '<div class="record-item">' +
                                '<span class="date">' + formatDate(record.date) + '</span>' +
                                '<span class="weight">' + record.weight + 'kg</span>' +
                                '<button class="delete-btn" onclick="deleteRecord(' + actualIndex + ')">ÏÇ≠Ï†ú</button>' +
                                '</div>';
                    })
                    .join('');
                
                recordsList.innerHTML = recordsHTML;
            } catch (error) {
                console.error('Í∏∞Î°ù ÌëúÏãú Ïò§Î•ò:', error);
                recordsList.innerHTML = '<p style="text-align: center; color: #f44336;">Í∏∞Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>';
            }
        }

        // Í∏∞Î°ù ÏÇ≠Ï†ú (ÌôïÏù∏ Ï†àÏ∞® Í∞ïÌôî)
        function deleteRecord(index) {
            if (index < 0 || index >= weightRecords.length) {
                alert('ÏûòÎ™ªÎêú Í∏∞Î°ùÏûÖÎãàÎã§.');
                return;
            }
            
            const record = weightRecords[index];
            if (!record) {
                alert('Í∏∞Î°ùÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const confirmMessage = formatDate(record.date) + 'Ïùò ' + record.weight + 'kg Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?';
            
            if (confirm(confirmMessage)) {
                try {
                    weightRecords.splice(index, 1);
                    if (storage.set('weightRecords', weightRecords)) {
                        displayRecords();
                        updateChart();
                        showMessage('record-result', 'Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'success');
                    } else {
                        // Î°§Î∞±
                        weightRecords.splice(index, 0, record);
                        alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                    }
                } catch (error) {
                    console.error('Í∏∞Î°ù ÏÇ≠Ï†ú Ïò§Î•ò:', error);
                    alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                }
            }
        }

        // Í∞ÑÎã®Ìïú Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞ (Chart.js ÏóÜÏù¥)
        function drawSimpleChart() {
            const container = document.getElementById('simple-chart');
            if (!container || weightRecords.length === 0) {
                if (container) {
                    container.innerHTML = '<div class="chart-message">Í∏∞Î°ùÏù¥ ÏóÜÏñ¥ÏÑú Ï∞®Ìä∏Î•º ÌëúÏãúÌï† Ïàò ÏóÜÏäµÎãàÎã§.</div>';
                }
                return;
            }
            
            try {
                const weights = weightRecords.map(r => r.weight);
                const dates = weightRecords.map(r => formatDate(r.date));
                const minWeight = Math.min(...weights);
                const maxWeight = Math.max(...weights);
                const weightRange = maxWeight - minWeight || 1;
                
                let html = '<div style="font-weight: bold; margin-bottom: 10px; text-align: center;">Ï≤¥Ï§ë Î≥ÄÌôî Ï∂îÏù¥</div>';
                html += '<div style="display: flex; flex-direction: column; height: 200px;">';
                
                // Í∞ÑÎã®Ìïú ÎßâÎåÄ Í∑∏ÎûòÌîÑ
                for (let i = 0; i < Math.min(weightRecords.length, 10); i++) {
                    const record = weightRecords[weightRecords.length - 1 - i]; // ÏµúÏã†Î∂ÄÌÑ∞
                    const height = ((record.weight - minWeight) / weightRange) * 150 + 20;
                    const color = targetWeight ? 
                        (record.weight <= targetWeight ? '#4CAF50' : '#ff9800') : '#2196F3';
                    
                    html += '<div style="display: flex; align-items: end; margin: 2px 0;">';
                    html += '<div style="width: 80px; font-size: 12px; text-align: right; padding-right: 5px;">' + 
                            formatDate(record.date).split(' ')[0] + '</div>';
                    html += '<div style="background: ' + color + '; height: ' + height + 'px; width: 20px; margin: 0 5px;"></div>';
                    html += '<div style="font-size: 12px; color: #333;">' + record.weight + 'kg</div>';
                    html += '</div>';
                }
                
                if (targetWeight) {
                    html += '<div style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">';
                    html += 'Î™©Ìëú: ' + targetWeight + 'kg | ÌòÑÏû¨: ' + weights[weights.length - 1] + 'kg';
                    html += '</div>';
                }
                
                html += '</div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Í∞ÑÎã® Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞ Ïò§Î•ò:', error);
                container.innerHTML = '<div class="chart-message">Ï∞®Ìä∏Î•º Í∑∏Î¶¨Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</div>';
            }
        }

        // Chart.jsÎ•º ÏÇ¨Ïö©Ìïú Í≥†Í∏â Ï∞®Ìä∏
        function drawAdvancedChart() {
            if (!window.Chart || weightRecords.length === 0) {
                return false;
            }
            
            try {
                const ctx = document.getElementById('weightChart');
                if (!ctx) return false;
                
                ctx.getContext('2d');
                
                // Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†úÍ±∞
                if (chart) {
                    chart.destroy();
                }
                
                const labels = weightRecords.map(record => formatDate(record.date));
                const data = weightRecords.map(record => record.weight);
                const goalLine = targetWeight ? Array(labels.length).fill(targetWeight) : null;
                
                const datasets = [{
                    label: 'Ï≤¥Ï§ë (kg)',
                    data: data,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true
                }];
                
                if (goalLine) {
                    datasets.push({
                        label: 'Î™©Ìëú Ï≤¥Ï§ë',
                        data: goalLine,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderDash: [5, 5],
                        tension: 0,
                        fill: false
                    });
                }
                
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Ï≤¥Ï§ë Î≥ÄÌôî Ï∂îÏù¥'
                            },
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Ï≤¥Ï§ë (kg)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'ÎÇ†Ïßú'
                                }
                            }
                        }
                    }
                });
                
                // Í≥†Í∏â Ï∞®Ìä∏Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Í∑∏Î†§ÏßÄÎ©¥ Í∞ÑÎã® Ï∞®Ìä∏ Ïà®Í∏∞Í∏∞
                document.getElementById('simple-chart').style.display = 'none';
                ctx.style.display = 'block';
                return true;
            } catch (error) {
                console.error('Í≥†Í∏â Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞ Ïò§Î•ò:', error);
                return false;
            }
        }

        // Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ (fallback Ìè¨Ìï®)
        function updateChart() {
            // Chart.jsÍ∞Ä Î°úÎìúÎêòÏñ¥ ÏûàÍ≥† Ïò®ÎùºÏù∏Ïù¥Î©¥ Í≥†Í∏â Ï∞®Ìä∏ ÏãúÎèÑ
            if (chartJsLoaded && window.Chart) {
                if (drawAdvancedChart()) {
                    return; // ÏÑ±Í≥µÌïòÎ©¥ Ï¢ÖÎ£å
                }
            }
            
            // Chart.js Î°úÎìú ÏãúÎèÑ (Ïò®ÎùºÏù∏Ïùº ÎïåÎßå)
            if (isOnline && !chartJsLoaded) {
                loadChartJs().then(function(loaded) {
                    if (loaded && drawAdvancedChart()) {
                        return;
                    }
                    // Ïã§Ìå®ÌïòÎ©¥ Í∞ÑÎã® Ï∞®Ìä∏Î°ú fallback
                    document.getElementById('weightChart').style.display = 'none';
                    document.getElementById('simple-chart').style.display = 'block';
                    drawSimpleChart();
                });
            } else {
                // Ïò§ÌîÑÎùºÏù∏Ïù¥Í±∞ÎÇò Chart.js Î°úÎìú Ïã§Ìå® Ïãú Í∞ÑÎã® Ï∞®Ìä∏ ÏÇ¨Ïö©
                document.getElementById('weightChart').style.display = 'none';
                document.getElementById('simple-chart').style.display = 'block';
                drawSimpleChart();
            }
        }

        // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        function loadData() {
            try {
                weightRecords = storage.get('weightRecords', []);
                targetWeight = storage.get('targetWeight', null);
                
                // Îç∞Ïù¥ÌÑ∞ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                if (!Array.isArray(weightRecords)) {
                    weightRecords = [];
                }
                
                // ÏûòÎ™ªÎêú Í∏∞Î°ù ÌïÑÌÑ∞ÎßÅ
                weightRecords = weightRecords.filter(record => {
                    return record && 
                           typeof record.date === 'string' && 
                           typeof record.weight === 'number' && 
                           record.weight > 0 && 
                           record.weight < 1000;
                });
                
                if (targetWeight !== null && (typeof targetWeight !== 'number' || targetWeight <= 0)) {
                    targetWeight = null;
                }
                
            } catch (error) {
                console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
                weightRecords = [];
                targetWeight = null;
            }
        }

        // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
        function initializePage() {
            try {
                // ÌòÑÏû¨ ÎÇ†Ïßú ÏÑ§Ï†ï
                const dateInput = document.getElementById('record-date');
                if (dateInput) {
                    dateInput.value = getCurrentDate();
                }
                
                // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                loadData();
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                displayGoal();
                displayRecords();
                updateChart();
                updateOnlineStatus();
                
                console.log('ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            } catch (error) {
                console.error('ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                alert('ÌéòÏù¥ÏßÄ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        function setupEventListeners() {
            try {
                // Ïò®ÎùºÏù∏/Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉú Í∞êÏßÄ
                window.addEventListener('online', updateOnlineStatus);
                window.addEventListener('offline', updateOnlineStatus);
                
                // Enter ÌÇ§ Ïù¥Î≤§Ìä∏
                document.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const target = e.target;
                        if (target.id === 'height' || target.id === 'weight') {
                            calculateBMI();
                        } else if (target.id === 'target-weight') {
                            setGoal();
                        } else if (target.id === 'record-date' || target.id === 'record-weight') {
                            addRecord();
                        }
                    }
                });
                
                // ÏóêÎü¨ Ìï∏Îì§ÎßÅ
                window.addEventListener('error', function(e) {
                    console.error('Ï†ÑÏó≠ Ïò§Î•ò:', e.error);
                });
                
                window.addEventListener('unhandledrejection', function(e) {
                    console.error('Ï≤òÎ¶¨ÎêòÏßÄ ÏïäÏùÄ Promise Ïò§Î•ò:', e.reason);
                });
                
            } catch (error) {
                console.error('Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï Ïò§Î•ò:', error);
            }
        }

        // DOM Î°úÎìú ÏôÑÎ£å Ïãú Ï¥àÍ∏∞Ìôî
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setupEventListeners();
                initializePage();
            });
        } else {
            setupEventListeners();
            initializePage();
        }
    </script>
</body>
</html>